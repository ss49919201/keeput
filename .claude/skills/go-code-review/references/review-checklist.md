# Go コードレビューチェックリスト

このドキュメントは、Goコードをレビューする際の一般的なチェックリストです。

---

## 使い方

レビュー時に以下の各項目を順番に確認してください。該当しない項目はスキップできます。

---

## 1. コーディング規約

### フォーマット

- [ ] `gofmt` または `goimports` でフォーマットされているか
- [ ] インポート文が標準ライブラリ、外部、内部の順に整理されているか
- [ ] 不要な空行がないか

### 命名規則

- [ ] パッケージ名が小文字の単一単語か
- [ ] 公開関数/型が大文字で始まっているか
- [ ] 変数名がスコープに応じた適切な長さか
- [ ] スネークケースを使っていないか

### コメント

- [ ] 公開関数/型にGoDocコメントがあるか
- [ ] コメントが型/関数名で始まっているか
- [ ] 自明なコードに不要なコメントを書いていないか

---

## 2. エラーハンドリング

### エラーチェック

- [ ] 全てのエラーをチェックしているか
- [ ] `_` でエラーを無視していないか
- [ ] エラー時に適切な処理をしているか

### エラーのラップ

- [ ] `fmt.Errorf` の `%w` でエラーをwrapしているか
- [ ] エラーメッセージに具体的なコンテキストが含まれているか
- [ ] エラーチェーン(`errors.Is`, `errors.As`)が適切に使われているか

### panicの使用

- [ ] panicを通常の処理で使っていないか
- [ ] panicは初期化時の致命的エラーのみか
- [ ] recoverが適切に使われているか(使っている場合)

---

## 3. 並行処理

### Goroutineの使用

- [ ] Goroutineの終了条件が明確か
- [ ] Contextでキャンセルを制御しているか
- [ ] Goroutineリークの可能性がないか
- [ ] `defer wg.Done()` でWaitGroupを確実に減らしているか

### Channelの使用

- [ ] バッファサイズが適切か
- [ ] 全てのgoroutineの結果を待っているか
- [ ] Channelのクローズが適切か(または不要か)
- [ ] Busy loopになっていないか(selectのdefault使用時)
- [ ] クローズされたchannelへの送信がないか

### 共有変数へのアクセス

- [ ] 共有変数へのアクセスが保護されているか(mutex、atomic、channelなど)
- [ ] Mapへの並行書き込みがないか
- [ ] Sliceへの並行appendがないか
- [ ] Race conditionの可能性がないか

### sync.OnceとMutex

- [ ] 高コストな初期化が `sync.Once` で遅延されているか
- [ ] Mutexのロック範囲が必要最小限か
- [ ] 読み取り専用の場合、`RWMutex.RLock` を使っているか
- [ ] deferでmutexをアンロックしているか

---

## 4. 関数とメソッド

### 関数設計

- [ ] 1つの関数が1つの責務を持っているか
- [ ] 関数が適切な長さか(目安: 50行以内)
- [ ] 引数が多すぎないか(目安: 3-4個以内)
- [ ] 戻り値が適切か

### レシーバー

- [ ] レシーバー名が一貫しているか
- [ ] ポインタレシーバーが必要な場合に使われているか
  - 構造体を変更する
  - 大きな構造体
  - 一貫性のため(他のメソッドがポインタレシーバーの場合)

---

## 5. 制御構造

### if文

- [ ] 早期リターンでネストを浅くしているか
- [ ] 不要な `else` を使っていないか
- [ ] 条件が読みやすいか

### for文

- [ ] `range` を使えるところで使っているか
- [ ] ループ変数のキャプチャ問題がないか(Go 1.22以前)
- [ ] 無限ループに終了条件があるか

### switch文

- [ ] `fallthrough` の使用が適切か(基本的には避ける)
- [ ] `default` ケースがあるか(必要な場合)

---

## 6. データ構造

### Slice

- [ ] 容量が事前に確保されているか `make([]T, 0, capacity)`
- [ ] Sliceの再スライスで意図しないメモリ保持がないか
- [ ] 並行アクセスが保護されているか

### Map

- [ ] Mapの初期化が適切か
- [ ] nilマップへの書き込みがないか
- [ ] 並行アクセスが保護されているか(`sync.Map`またはmutex)
- [ ] 存在チェックで2値受け取りを使っているか

### Struct

- [ ] ゼロ値で有効な構造体設計になっているか
- [ ] フィールドの順序が適切か(メモリアライメント考慮)
- [ ] 埋め込み(embedding)が適切に使われているか

---

## 7. インターフェース

### インターフェース設計

- [ ] インターフェースが小さいか(メソッド数1-3個が理想)
- [ ] 使う側で定義されているか
- [ ] 不要な抽象化をしていないか

### 型アサーション

- [ ] 型アサーションで2値受け取りを使っているか
- [ ] パニックを避けるための確認があるか

---

## 8. リソース管理

### deferの使用

- [ ] ファイル、接続などのリソースを `defer` で解放しているか
- [ ] deferの実行順序を理解しているか(LIFO)
- [ ] ループ内でのdefer使用に注意しているか

### Context

- [ ] Contextが適切に伝播されているか
- [ ] Context.Valueは必須パラメータではなくリクエストスコープデータのみか
- [ ] タイムアウトやキャンセルが適切に処理されているか

---

## 9. テスト

### テーブルドリブンテスト

- [ ] テストケース名が具体的な挙動を説明しているか
- [ ] `t.Run` でサブテストを実行しているか
- [ ] エッジケースがカバーされているか

### テストの独立性

- [ ] テストが他のテストに依存していないか
- [ ] テストが順序に依存していないか
- [ ] グローバル状態を変更していないか

### アサーション

- [ ] 期待値と実際の値が明確か
- [ ] エラーメッセージが有用か

---

## 10. セキュリティ

### 入力検証

- [ ] 外部入力のバリデーションが適切か
- [ ] SQLインジェクションの可能性がないか
- [ ] コマンドインジェクションの可能性がないか

### シークレット管理

- [ ] ハードコードされたシークレットがないか
- [ ] 環境変数から適切にシークレットを取得しているか
- [ ] ログにシークレットが出力されていないか

---

## 11. パフォーマンス

### メモリ効率

- [ ] 不要なメモリアロケーションがないか
- [ ] Sliceの容量が事前に確保されているか
- [ ] Stringの連結が効率的か(`strings.Builder`など)

### ロック範囲

- [ ] Mutexのロック範囲が必要最小限か
- [ ] I/O操作をロック内で行っていないか

---

## 12. 静的解析ツール

レビュー前に以下のツールを実行することを推奨:

```bash
# 基本チェック
go vet ./...

# Race detector
go test -race ./...

# 静的解析
staticcheck ./...

# 総合Linter
golangci-lint run
```

---

## レビュー時のヒント

1. **優先順位**: 並行処理の安全性 > エラーハンドリング > コーディング規約 > パフォーマンス
2. **コードを読む前に**: テストを先に読んで、意図を理解する
3. **セキュリティ**: 外部入力を受け取る箇所は特に注意深くレビュー
4. **可読性**: コードが自己説明的か、過度に複雑でないか

---

## レビューコメントのテンプレート

### 重大な問題

```
❌ [並行処理] Race conditionの可能性があります
ファイル: xxx.go:123
理由: 共有変数への並行アクセスが保護されていません
提案: mutexまたはchannelで保護してください
参照: references/concurrency-review.md#race-conditionの検出
```

### 改善提案

```
⚠️ [コーディング規約] 早期リターンを推奨します
ファイル: xxx.go:456
理由: ネストが深く読みにくいです
提案: if err != nil { return err } パターンを使ってください
参照: references/go-coding-standards.md#if文
```

### 質問

```
❓ [設計] この関数は分割できませんか?
ファイル: xxx.go:789
理由: 100行を超えており、複数の責務を持っているように見えます
```

### 良い点

```
✅ [エラーハンドリング] エラーのラップが適切です
ファイル: xxx.go:101
理由: %w でエラーチェーンを保持しています
```
